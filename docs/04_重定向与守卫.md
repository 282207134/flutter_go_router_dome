# 重定向与守卫

## 全局重定向

使用 `GoRouter` 构造函数中的 `redirect` 参数，可以根据状态对所有导航进行统一拦截。

```dart
final router = GoRouter(
  refreshListenable: authNotifier,
  redirect: (context, state) {
    final isLoggedIn = authNotifier.isLoggedIn;
    final isLoggingIn = state.matchedLocation == '/login';

    if (!isLoggedIn && !isLoggingIn) {
      return '/login';
    }

    if (isLoggedIn && isLoggingIn) {
      return '/home';
    }

    return null; // 返回 null 表示不重定向
  },
  routes: [...],
);
```

## 路由级别守卫

每个 `GoRoute` 都可以定义自己的 `redirect`，用于路由级别的拦截。

```dart
GoRoute(
  path: '/premium',
  redirect: (context, state) => subscription.isActive ? null : '/upgrade',
  builder: (context, state) => const PremiumPage(),
)
```

## 使用 `redirect` 实现权限控制

1. 根据登录状态重定向到登录页
2. 根据用户角色重定向到无权限页面
3. 根据网络状态或应用状态进行重定向

## 守卫最佳实践

- **集中管理权限状态**：使用 `ChangeNotifier` 或 `Riverpod`、`Bloc` 等状态管理工具
- **搭配 `refreshListenable`**：状态变更时自动刷新路由重定向逻辑
- **避免无限重定向**：确保重定向目标路径不会再次触发相同重定向

## `refreshListenable`

`refreshListenable` 用于监听状态变更并自动刷新路由。

```dart
final authNotifier = ValueNotifier<bool>(false);

final router = GoRouter(
  refreshListenable: authNotifier,
  redirect: (context, state) {
    return authNotifier.value ? null : '/login';
  },
  routes: [...],
);
```

当 `authNotifier.value` 发生变化时，go_router 会自动执行 `redirect`，无需手动调用。

## `redirect` 中的状态读取

通常会在 `redirect` 中读取全局状态，如 Provider、Riverpod、Bloc。

```dart
final router = GoRouter(
  redirect: (context, state) {
    final authState = Provider.of<AuthState>(context, listen: false);
    if (!authState.isLoggedIn) {
      return '/login';
    }
    return null;
  },
  routes: [...],
);
```

## 错误页面与重定向组合

```dart
GoRouter(
  errorBuilder: (context, state) => ErrorPage(error: state.error),
  routes: [...],
  redirect: (context, state) {
    if (state.error != null) {
      return '/error';
    }
    return null;
  },
)
```

## 调试重定向

可以通过 `GoRouterObserver` 或手动打印帮助调试：

```dart
router.addListener(() {
  debugPrint('当前路由: ${router.location}');
});
```
