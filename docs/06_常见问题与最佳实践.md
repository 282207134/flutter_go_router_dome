# 常见问题与最佳实践

## 常见问题

### 1. 如何处理 404 页面？

使用 `errorBuilder` 捕获路由错误：

```dart
final router = GoRouter(
  errorBuilder: (context, state) => ErrorPage(error: state.error),
  routes: [...],
);
```

### 2. 如何在不同页面间传递复杂对象？

使用 `extra` 参数：

```dart
context.push('/details', extra: ComplexObject(...));

// 在目标页面获取
final data = GoRouterState.of(context).extra as ComplexObject;
```

### 3. 如何实现登录拦截？

使用全局 `redirect` 配合 `refreshListenable`：

```dart
final authNotifier = ValueNotifier<bool>(false);

final router = GoRouter(
  refreshListenable: authNotifier,
  redirect: (context, state) {
    final isLoggedIn = authNotifier.value;
    final isLoggingIn = state.matchedLocation == '/login';
    
    if (!isLoggedIn && !isLoggingIn) {
      return '/login?from=${Uri.encodeComponent(state.uri.toString())}';
    }
    return null;
  },
  routes: [...],
);
```

### 4. 如何在底部导航栏中保持状态？

使用 `StatefulShellRoute.indexedStack`：

```dart
StatefulShellRoute.indexedStack(
  builder: (context, state, navigationShell) {
    return BottomNavScaffold(navigationShell: navigationShell);
  },
  branches: [
    StatefulShellBranch(routes: [...]),
    StatefulShellBranch(routes: [...]),
  ],
)
```

### 5. 如何监听路由变化？

可以使用 `RouteObserver` 或监听 `GoRouter` 本身：

```dart
router.addListener(() {
  print('当前路由：${router.location}');
});
```

### 6. 如何获取当前路由信息？

```dart
final location = GoRouter.of(context).location;
final state = GoRouterState.of(context);
```

### 7. 如何自定义转场动画？

使用 `pageBuilder` 并返回自定义的 `CustomTransitionPage`：

```dart
GoRoute(
  path: '/fade',
  pageBuilder: (context, state) => CustomTransitionPage(
    key: state.pageKey,
    child: MyPage(),
    transitionsBuilder: (context, animation, secondaryAnimation, child) {
      return FadeTransition(opacity: animation, child: child);
    },
  ),
)
```

### 8. 如何处理返回结果？

```dart
// 子页面返回结果
context.pop('some result');

// 父页面接收结果
final result = await context.push('/child');
print(result); // 'some result'
```

### 9. 如何处理 Web 的浏览器后退按钮？

go_router 自动处理浏览器的前进/后退，无需额外代码。

### 10. 如何处理嵌套路由中的参数？

子路由可以访问父路由的参数：

```dart
GoRoute(
  path: '/user/:userId',
  routes: [
    GoRoute(
      path: 'posts/:postId',
      builder: (context, state) {
        final userId = state.pathParameters['userId'];
        final postId = state.pathParameters['postId'];
        return PostPage(userId: userId, postId: postId);
      },
    ),
  ],
)
```

## 最佳实践

### 1. 集中管理路由配置

将所有路由配置放在单独的文件中，便于维护：

```dart
// router.dart
final appRouter = GoRouter(
  routes: AppRoutes.routes,
);

// app_routes.dart
class AppRoutes {
  static final routes = [
    GoRoute(...),
    GoRoute(...),
  ];
}
```

### 2. 使用命名路由

给常用路由定义名称，避免硬编码路径：

```dart
GoRoute(
  path: '/profile/:id',
  name: 'profile',
  builder: ...,
)

// 使用
context.goNamed('profile', pathParameters: {'id': '123'});
```

### 3. 类型安全的路由管理

创建路由常量类：

```dart
class RouteNames {
  static const home = 'home';
  static const profile = 'profile';
  static const settings = 'settings';
}

class RoutePaths {
  static const home = '/home';
  static const profile = '/profile/:id';
  static const settings = '/settings';
}
```

### 4. 处理异步数据加载

在 `redirect` 中处理异步逻辑时要小心，避免阻塞 UI：

```dart
redirect: (context, state) async {
  // 避免在 redirect 中执行耗时操作
  // 应该在页面加载时异步获取数据
  return null;
}
```

### 5. 合理使用 ShellRoute 和 StatefulShellRoute

- 对于只需要共享布局的场景，使用 `ShellRoute`
- 对于需要保持状态的场景（如底部导航），使用 `StatefulShellRoute`

### 6. 错误处理

始终定义 `errorBuilder`，提供友好的错误页面。

### 7. 调试技巧

开启调试日志：

```dart
final router = GoRouter(
  debugLogDiagnostics: true,
  routes: [...],
);
```

### 8. 性能优化

- 使用 `const` 构造函数
- 避免在 `builder` 中执行耗时操作
- 对于大型页面，考虑懒加载

### 9. 测试路由

编写单元测试验证路由配置：

```dart
testWidgets('navigates to profile page', (tester) async {
  await tester.pumpWidget(MyApp());
  
  // 模拟导航
  final context = tester.element(find.byType(MyApp));
  context.goNamed('profile', pathParameters: {'id': '123'});
  
  await tester.pumpAndSettle();
  
  // 验证页面
  expect(find.byType(ProfilePage), findsOneWidget);
});
```

### 10. 文档化路由

为每个路由添加注释说明其用途、参数和权限要求：

```dart
/// 用户个人资料页面
/// 
/// 路径参数：
/// - id: 用户ID
/// 
/// 查询参数：
/// - tab: 可选，默认展示的标签页
/// 
/// 权限：需要登录
GoRoute(
  path: '/profile/:id',
  name: 'profile',
  builder: (context, state) => ProfilePage(
    userId: state.pathParameters['id']!,
    initialTab: state.uri.queryParameters['tab'],
  ),
)
```

## 性能建议

1. **路由预加载**：对于重要路由，可以提前构建页面
2. **避免过深的嵌套**：路由层级不宜超过 3-4 层
3. **合理使用 ShellRoute**：避免重复构建相同的布局
4. **缓存策略**：使用 `StatefulShellRoute` 保持关键页面状态
5. **减少重定向链**：避免多次连续重定向
